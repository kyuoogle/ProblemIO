<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.problemio.item.mapper.CustomItemMapper">

    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO custom_items (item_type, name, description, config, is_default, created_at)
        VALUES (#{itemType}, #{name}, #{description}, #{config}, #{isDefault}, NOW())
    </insert>

    <select id="findById" resultType="com.problemio.item.domain.CustomItem">
        SELECT * FROM custom_items WHERE id = #{id}
    </select>
    
    <select id="findAll" resultType="com.problemio.item.domain.CustomItem">
        SELECT * FROM custom_items ORDER BY created_at DESC
    </select>

    <!-- 
      Retrieves items that are either:
      1. Default items (is_default = 1)
      2. Assigned to the user in user_items
    -->
    <resultMap id="CustomItemResponseMap" type="com.problemio.item.dto.CustomItemResponse">
        <id property="id" column="id"/>
        <result property="itemType" column="item_type"/>
        <result property="itemType" column="item_type"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="config" column="config"/>
        <result property="isDefault" column="is_default"/>
        <result property="createdAt" column="created_at"/>
        <result property="isOwned" column="isOwned"/>
    </resultMap>

    <select id="findItemsByUserId" resultMap="CustomItemResponseMap">
        SELECT 
            ci.id,
            ci.item_type,
            ci.name,
            ci.description,
            ci.config,
            ci.is_default,
            ci.created_at,
            TRUE as isOwned
        FROM custom_items ci
        WHERE ci.item_type = #{type}
          AND (
            ci.is_default = 1
            OR EXISTS (
                SELECT 1 FROM user_items ui 
                WHERE ui.item_id = ci.id AND ui.user_id = #{userId}
            )
          )
        ORDER BY ci.is_default DESC, ci.id ASC
    </select>

    <select id="existsUserItem" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_items
        WHERE user_id = #{userId} AND item_id = #{itemId}
    </select>

    <insert id="saveUserItem">
        INSERT INTO user_items (user_id, item_id, acquired_at)
        VALUES (#{userId}, #{itemId}, NOW())
    </insert>

    <update id="update">
        UPDATE custom_items
        SET 
            name = #{name},
            description = #{description},
            config = #{config},
            is_default = #{isDefault}
        WHERE id = #{id}
    </update>

    <select id="findAssignedUsers" resultType="com.problemio.user.domain.User">
        SELECT u.* 
        FROM users u
        JOIN user_items ui ON u.id = ui.user_id
        WHERE ui.item_id = #{itemId}
        AND u.is_deleted = 0
    </select>

    <delete id="deleteUserItem">
        DELETE FROM user_items
        WHERE user_id = #{userId} AND item_id = #{itemId}
    </delete>

</mapper>
